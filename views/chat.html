<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chat homepage</title>
    <style>
        .container {
            display: inline-flex;
            border-color: 1px solid black;
            width: 100%;

        }

        #textarea {
            width: 100%;
            display: inline-flex;
        }

        #messagearea {
            width: 75%;
            border: 1px solid aqua;
            margin: 1rem auto;
        }

        #messageDisplay {
            width: 100%;
            border: 1px solid aqua;
            height: 27rem;
            margin: 0rem auto;
            overflow: scroll;
        }

        #msgnavbar {
            width: 100%;
            background-color: rgb(197, 238, 224);
            height: 2rem;
            border: 1px solid aquamarine;
            display: inline-flex;
        }

        #tiles {
            width: 25%;
            border: 1px solid aqua;
            height: 27rem;
            margin: 1rem auto;
        }

        #navbar {
            width: 95%;
            border: 1px solid aquamarine;
            height: fit-content;
            text-align: center;
            margin: auto;
        }

        #sendmsg {
            width: 90%;
        }

        #bottomcontainer {
            width: 95%;
            margin-bottom: 0.5rem;
            position: absolute;
            bottom: 1rem;
            background-color: aquamarine;
        }

        #sendmsg {
            margin: 0.5rem auto;
            width: fit-content;
        }

        .hide {
            display: none;
        }

        .show {
            display: block;
        }

        li {
            list-style: none;
        }

        #groupnames div {
            border: 1px solid rgb(0, 183, 255);
            text-align: center;
            margin: 0.2rem;
            border-radius: 5px;
        }

    </style>
</head>

<body>
    <div id="navbar">
        <h3>CHAT APP</h3>
    </div>
    <div id="errordisplay"></div>
    <div id="textarea">
        <div id="tiles">
            <button type="submit" id="createnewgroup" style="margin:0.5rem 2rem;">create new group</button>
            <div class="hide" id="entergroupname">
                Enter Group name:
                <input type="text" name="groupname" id="groupname">
                <button type="submit" id="groupnamesbmtbtn">CREATE</button>
            </div>
            <div class="hide" id="showAllUser">

            </div>
            <div id="groupnames">

            </div>

        </div>
        <div id="messagearea">
            <div id="msgnavbar">
                <div id="GroupNamenav" style="position: relative; left: 1rem;"></div>
                <div id="createdBynav" style="position: absolute; right: 3rem;"></div>
            </div>
            <div id="messageDisplay">

            </div>
        </div>

    </div>


    <div id="bottomcontainer">
        <div id="sendmsg">
            <input type="text" name="msg" id="messages" style="width: 25rem; height: 2rem;">
            <input type="submit" name="send" value="SEND" id="sendbtn" style="width: 3rem; height: 2rem;">
        </div>
    </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
<script>
    let currentuser;
    const token = localStorage.getItem('token');
    var indexOfMsgSaved = 0;
    const display = document.getElementById('messageDisplay');
    const errordisplay = document.getElementById('errordisplay');
    const submitbtn = document.getElementById('sendbtn');

    submitbtn.addEventListener('click', async (e) => {
        try {
            e.preventDefault();
            const msg1 = document.getElementById('messages').value;
            currentgroupId = localStorage.getItem('currentGroupId') | 0;
            const res = await axios.post('http://localhost:5000/sendMessage', { msg: msg1, groupid: currentgroupId }, { headers: { "Authorization": token } });
            console.log(res.data);
        }
        catch (err) {
            console.log(err);
            errordisplay.innerHTML = `something went wrong - ${err}`;
        }
    });

    // calling API repeatedly
    setInterval(makechatrealtime, 500);
    setInterval(updategrouptile, 10999);

    async function updategrouptile() {
        const groupnames = document.getElementById('groupnames');
        groupnames.innerHTML = '';
        await displayAllGroup();
    }

    //function to make chat realtime
    async function makechatrealtime() {
        try {
            currentId = localStorage.getItem('currentGroupId') | 0;
            const res = await axios.get('http://localhost:5000/getCurrentUser', { headers: { "Authorization": token } })
            console.log(res.data.currentuser);
            currentuser = res.data.currentuser;
            if (currentId === 0) {
                savemessagetoLS();
            }
            else {
                const resp = await axios.post('http://localhost:5000/getParticularGroupMessage', { groupId: currentId });
                //cleaning the screen so that message donot repeat
                display.innerHTML = '';
                //displaying message on screen received from database
                for (let i = 0; i < resp.data.message.length; i++) {
                    display.innerHTML += resp.data.message[i].name + ':' + resp.data.message[i].dataValues.message + `<br>`;
                }
            }
            if (currentId == 0 || currentId == undefined || currentId == null) {
                // document.getElementById("0").style.backgroundColor = "aqua";
            }
            else {
                document.getElementById(`${currentId}`).style.backgroundColor = "aqua";
            }
        }
        catch (err) {
            console.log(err);
            errordisplay.innerHTML = `something went wrong - ${err}`;
        }
    }



    //function when page is refreshed
    window.addEventListener('DOMContentLoaded', async (e) => {
        await displayAllGroup();
        currentId = localStorage.getItem('currentGroupId') | 0;
        const res = await axios.get('http://localhost:5000/getCurrentUser', { headers: { "Authorization": token } })
        console.log(res.data.currentuser);
        currentuser = res.data.currentuser;
        if (currentId === 0) {
            savemessagetoLS();
        }
        else {
            await getParticularGroupMessage();
        }

        if (currentId === 0 || currentId == undefined || currentId == null) {
            document.getElementById('0').style.backgroundColor = "aqua";
        }
        else {
            document.getElementById(`${currentId}`).style.backgroundColor = "aqua";
        }

    });

    async function getParticularGroupMessage() {
        try {
            currentId = localStorage.getItem('currentGroupId') | 0;
            const resp = await axios.post('http://localhost:5000/getParticularGroupMessage', { groupId: currentId });
            //cleaning the screen so that message donot repeat
            display.innerHTML = '';
            //displaying message on screen received from database
            for (let i = 0; i < resp.data.message.length; i++) {
                display.innerHTML += resp.data.message[i].name + ':' + resp.data.message[i].dataValues.message + `<br>`;
            }
        }
        catch (err) {
            errordisplay.innerHTML = `something went wrong - ${err}`;
        }

    }

    async function savemessagetoLS() {
        try {
            messages = [];
            //To find latest message, calculating ID from where we should read messages.
            var startingFilterIndex = (indexOfMsgSaved - 15) > 0 ? indexOfMsgSaved - 15 : 0;
            const res = await axios.get(`http://localhost:5000/getCommonGroupMessage?start=${startingFilterIndex}`);
            //storing highest ID that we received.
            indexOfMsgSaved = res.data.message[res.data.message.length - 1].dataValues.id;
            display.innerHTML = '';

            //getting last 15 latest message starting index
            const startingidx = (res.data.message.length - 15) > 0 ? res.data.message.length - 15 : 0;
            //push 15 latest message to array messages
            for (let i = startingidx; i < res.data.message.length; i++) {
                messages.push(res.data.message[i].name + ':' + res.data.message[i].dataValues.message);
            }
            //stringify array
            let string = JSON.stringify(messages);
            //storing latest 15 message in form of array in local storage
            localStorage.setItem("messages", string);

            //reading message from localstorage and display on screen
            updatechatonscreen();
        }
        catch (err) {
            console.log(err);
            errordisplay.innerHTML = `something went wrong - ${err}`;
        }
    }

    async function updatechatonscreen() {
        try {
            // Retrieving the string
            let retString = localStorage.getItem("messages")
            // Retrieved array
            let retArray = JSON.parse(retString)
            //cleaning the screen so that message donot repeat
            display.innerHTML = '';
            //displaying message on screen which is read from localstorage
            for (let i = 0; i < retArray.length; i++) {
                display.innerHTML += retArray[i] + `<br>`;
            }
        }
        catch (err) {
            console.log(err);
            errordisplay.innerHTML = `something went wrong - ${err}`;
        }
    }

    const createnewgroup = document.getElementById('createnewgroup');
    createnewgroup.addEventListener('click', async (e) => {
        e.preventDefault();
        const entergroupname = document.getElementById('entergroupname');
        entergroupname.classList.toggle('show');
        const groupnamesbmtbtn = document.getElementById('groupnamesbmtbtn');
        groupnamesbmtbtn.addEventListener('click', async (e) => {
            e.preventDefault();
            entergroupname.style.display = 'none';
            const groupName = document.getElementById('groupname').value;
            const resp = await axios.post('http://localhost:5000/createGroup', { groupname: groupName }, { headers: { "Authorization": token } });
            console.log(resp.data.response.id);
            const res = await axios.get('http://localhost:5000/getAllUser');
            console.log(res.data.user);
            const showAllUser = document.getElementById('showAllUser');
            showAllUser.classList.toggle('show');
            showAllUserOnTile(res.data.user, resp.data.response.id);
        })

    });
    //show user when clicked on createGroup button.
    async function showAllUserOnTile(obj, groupID) {
        const showAllUser = document.getElementById('showAllUser');
        for (let i = 0; i < obj.length; i++) {
            if (obj[i].name === currentuser) {
                continue;
            }
            const div = document.createElement('div');
            const li = document.createElement('li');
            // li.appendChild(document.createTextNode(obj[i].id));
            // li.appendChild(document.createTextNode('-'));
            li.appendChild(document.createTextNode(obj[i].name));
            var newCheckBox = document.createElement('input');
            newCheckBox.type = 'checkbox';
            newCheckBox.name = 'user';
            newCheckBox.id = `${obj[i].id}`;
            li.appendChild(newCheckBox);
            div.appendChild(li);

            showAllUser.appendChild(div);

        }
        const addUser = document.createElement('button');
        addUser.innerHTML = 'Add user';
        showAllUser.appendChild(addUser);

        addUser.addEventListener('click', async (e) => {
            e.preventDefault();
            var checkboxes =
                document.getElementsByName('user');
            let ids = [];
            for (var i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    // console.log(checkboxes[i].value, checkboxes[i].id);
                    ids.push(checkboxes[i].id);
                }
            }
            const res = await axios.post('http://localhost:5000/addUsersToGroup', { ids: ids, groupid: groupID }, { headers: { "Authorization": token } })
            location.reload();
        })
    }

    //display all group with currentUser as member on left tiles
    async function displayAllGroup() {
        try {
            const res = await axios.get('http://localhost:5000/getAllUserGroup', { headers: { "Authorization": token } });
            console.log(res.data);
            obj = { id: 0, groupname: "Common Group", createdby: '' };
            showGroupNameontile(obj);
            for (let i = 0; i < res.data.groupdata.length; i++) {
                showGroupNameontile(res.data.groupdata[i]);
            }

        }
        catch (err) {
            console.log(res);
            errordisplay.innerHTML = `something went wrong - ${err}`;
        }
    }

    async function showGroupNameontile(obj) {
        const groupnames = document.getElementById('groupnames');

        const div = document.createElement('div');
        div.id = `${obj.id}`;
        div.style = "border: 1px solid black";
        const li = document.createElement('li');
        li.appendChild(document.createTextNode(obj.groupname));
        // li.appendChild(document.createTextNode('-'));
        // li.appendChild(document.createTextNode(obj.createdby));
        div.appendChild(li);
        groupnames.appendChild(div);


        div.addEventListener('click', async (e) => {
            e.preventDefault();
            currentId = div.id | '0';
            previousId = localStorage.getItem('currentGroupId') | '0';
            document.getElementById(`${previousId}`).style.backgroundColor = 'white';
            localStorage.setItem("currentGroupId", currentId);
            document.getElementById(`${currentId}`).style.backgroundColor = "aqua";

            document.getElementById('GroupNamenav').innerHTML = obj.groupname;
            if(currentId==0){
                document.getElementById('createdBynav').innerHTML='';
            }else{
            document.getElementById('createdBynav').innerHTML = "created By: "+ obj.createdby;
            }
        })
    }


</script>

</html>